<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>I Ching - Ritual Reading</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="./js/common.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #f5f5f0 0%, #e8e8e0 100%);
            min-height: 100vh; /* fallback */
            color: #2c2c2c;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-text-size-adjust: 100%;
        }

        /* Using 100vh fallback for broader CSS compatibility */

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0 12px;
            border-bottom: 1px solid #d0d0c8;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 22px;
            font-weight: normal;
            letter-spacing: 2px;
            color: #1a1a1a;
        }

        .date {
            margin-top: 6px;
            font-size: 12px;
            color: #666;
        }

        /* Main Sections */
        .section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .nav-tab {
            padding: 6px 12px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .nav-tab.active {
            color: #1a1a1a;
            border-bottom-color: #1a1a1a;
        }

        /* Clear, accessible focus rings */
        .nav-tab:focus-visible,
        .trigram-card:focus-visible,
        .cast-button:focus-visible,
        .trans-btn:focus-visible {
            outline: 2px solid #8aa9ff;
            outline-offset: 2px;
            border-radius: 6px;
        }

        /* Cast Section */
        .cast-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
        }

        .hexagram-lines {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            margin-bottom: 16px;
        }

        .line {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .line-number {
            font-size: 11px;
            color: #999;
            width: 20px;
        }

        .line-display {
            width: 100px;
            height: 7px;
            background: #1a1a1a;
            position: relative;
        }

        .line-display.broken {
            background: linear-gradient(to right, #1a1a1a 45%, transparent 45%, transparent 55%, #1a1a1a 55%);
        }

        .line-display.changing::after {
            content: '‚óè';
            position: absolute;
            right: -25px;
            top: -4px;
            color: #d4776d;
            font-size: 16px;
        }

        .cast-button {
            background: #2c2c2c;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .cast-button:hover {
            background: #1a1a1a;
            transform: translateY(-2px);
        }

        .throw-result {
            margin-top: 12px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        /* Trigram Finder */
        .trigram-selector {
            margin-bottom: 16px;
        }

        .trigram-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 8px;
        }

        .trigram-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .trigram-card {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .trigram-card:hover {
            background: #fff;
            border-color: #999;
            transform: translateY(-2px);
        }

        .trigram-card.selected {
            background: #2c2c2c;
            color: white;
            border-color: #2c2c2c;
        }

        .trigram-symbol {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .trigram-name {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Result Display */
        .result-hexagram {
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 88px 1fr;
            gap: 12px 16px;
            align-items: center;
        }

        .hex-number {
            font-size: 36px;
            font-weight: 300;
            color: #1a1a1a;
            margin-bottom: 6px;
        }

        .hex-symbol {
            font-size: 88px;
            line-height: 1;
            margin-bottom: 6px;
        }

        .hex-name {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .hex-chinese {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
        }

        .transformation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 16px 0;
        }

        .arrow {
            color: #999;
            font-size: 18px;
        }

        /* Reading Section */
        .translation-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 8px;
        }

        .trans-btn {
            flex: 1;
            padding: 6px;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 11px;
            transition: all 0.3s;
        }

        .trans-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reading-text {
            line-height: 1.6;
            color: #333;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .reading-text h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin: 12px 0 6px;
        }

        .changing-lines {
            border-top: 1px solid #e0e0e0;
            padding-top: 12px;
        }

        .changing-line-item {
            background: #fef9f5;
            border-left: 3px solid #d4776d;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .line-position {
            font-size: 11px;
            color: #d4776d;
            font-weight: bold;
            margin-bottom: 6px;
        }

        /* Current Hexagram Display */
        .current-hexagram-display {
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: 72px 1fr;
            gap: 8px 14px;
            align-items: center;
        }

        .current-hexagram-display .hex-symbol { font-size: 64px; margin-bottom: 0; }
        .result-hexagram .hex-symbol { margin-bottom: 0; }

        /* Smaller symbols in Cast transformation mini-cards */
        .trans-hex .hex-symbol { font-size: 28px; margin-bottom: 4px; }

        /* Cast animation */
        @keyframes pulseLine {
            0% { transform: scaleX(0.8); opacity: 0.6; }
            70% { transform: scaleX(1.05); opacity: 1; }
            100% { transform: scaleX(1); opacity: 1; }
        }
        .line-display.cast-animate { animation: pulseLine 180ms ease-out; }

        .current-hexagram-display .hex-number {
            font-size: 28px;
            font-weight: 300;
            color: #1a1a1a;
            margin-bottom: 6px;
        }

        .current-hexagram-display .hex-name {
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
        }

        .current-hexagram-display .hex-chinese {
            font-size: 11px;
            color: #666;
        }

        /* Screen-reader only utility */
        .sr-only {
            position: absolute;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 1px, 1px);
            white-space: nowrap; border: 0;
        }

        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .trigram-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* iPhone 13 mini targeted tweaks */
        @media (max-width: 380px) {
            .container { max-width: 360px; padding: 10px; }
            .header h1 { font-size: 20px; }
            .nav-tab { font-size: 11px; padding: 6px 8px; }
            .hex-number { font-size: 32px; }
            .hex-name { font-size: 15px; }
            .result-hexagram { padding: 14px; }
            .line-display { width: 92px; height: 6px; }
            .hexagram-lines { gap: 8px; }
            .translation-toggle { gap: 6px; }
        }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0ms !important; transition: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>I CHING</h1>
            <div class="date">Thursday, August 7, 2025</div>
        </div>

        <div class="nav-tabs" role="tablist" aria-label="Primary">
            <button id="tab-find" class="nav-tab active" role="tab" aria-controls="find" onclick="showSection(event, 'find')" aria-selected="true">Find</button>
            <button id="tab-reading" class="nav-tab" role="tab" aria-controls="reading" onclick="showSection(event, 'reading')" aria-selected="false">Reading</button>
            <button id="tab-cast" class="nav-tab" role="tab" aria-controls="cast" onclick="showSection(event, 'cast')" aria-selected="false">Cast</button>
        </div>

        <!-- Cast Section -->
        <div id="cast" class="section" role="tabpanel" aria-labelledby="tab-cast" aria-hidden="true">
            <div class="cast-display">
                <div class="hexagram-lines">
                    <div class="line">
                        <span class="line-number">1</span>
                        <div class="line-display broken"></div>
                    </div>
                    <div class="line">
                        <span class="line-number">2</span>
                        <div class="line-display"></div>
                    </div>
                    <div class="line">
                        <span class="line-number">3</span>
                        <div class="line-display broken changing"></div>
                    </div>
                    <div class="line">
                        <span class="line-number">4</span>
                        <div class="line-display changing"></div>
                    </div>
                    <div class="line">
                        <span class="line-number">5</span>
                        <div class="line-display broken"></div>
                    </div>
                    <div class="line">
                        <span class="line-number">6</span>
                        <div class="line-display broken"></div>
                    </div>
                </div>
                
                <button class="cast-button" id="cast-button">THROW COINS</button>
                
                <div class="throw-result" id="throw-result"></div>
            </div>

            <div class="transformation" id="transformation">
                <div class="trans-hex" id="primary-hex">
                    <div class="hex-symbol" id="primary-hex-symbol"></div>
                    <div class="hex-number trans-hex-number" id="primary-hex-number"></div>
                    <div class="hex-name" id="primary-hex-english"></div>
                    <div class="hex-chinese trans-hex-name" id="primary-hex-chinese"></div>
                </div>
                <div class="arrow">‚Üí</div>
                <div class="trans-hex" id="result-hex">
                    <div class="hex-symbol" id="result-hex-symbol"></div>
                    <div class="hex-number trans-hex-number" id="result-hex-number"></div>
                    <div class="hex-name" id="result-hex-english"></div>
                    <div class="hex-chinese trans-hex-name" id="result-hex-chinese"></div>
                </div>
            </div>
        </div>

        <!-- Find Section -->
        <div id="find" class="section active" role="tabpanel" aria-labelledby="tab-find" aria-hidden="false">
            <div class="trigram-selector">
                <div class="trigram-label">Lower Trigram</div>
                <div class="trigram-grid" id="lower-trigram-grid">
                    <div class="trigram-card" data-trigram="heaven">
                        <div class="trigram-symbol">‚ò∞</div>
                        <div class="trigram-name">Heaven</div>
                    </div>
                    <div class="trigram-card selected" data-trigram="earth">
                        <div class="trigram-symbol">‚ò∑</div>
                        <div class="trigram-name">Earth</div>
                    </div>
                    <div class="trigram-card" data-trigram="water">
                        <div class="trigram-symbol">‚òµ</div>
                        <div class="trigram-name">Water</div>
                    </div>
                    <div class="trigram-card" data-trigram="fire">
                        <div class="trigram-symbol">‚ò≤</div>
                        <div class="trigram-name">Fire</div>
                    </div>
                    <div class="trigram-card" data-trigram="thunder">
                        <div class="trigram-symbol">‚ò≥</div>
                        <div class="trigram-name">Thunder</div>
                    </div>
                    <div class="trigram-card" data-trigram="wind">
                        <div class="trigram-symbol">‚ò¥</div>
                        <div class="trigram-name">Wind</div>
                    </div>
                    <div class="trigram-card" data-trigram="mountain">
                        <div class="trigram-symbol">‚ò∂</div>
                        <div class="trigram-name">Mountain</div>
                    </div>
                    <div class="trigram-card" data-trigram="lake">
                        <div class="trigram-symbol">‚ò±</div>
                        <div class="trigram-name">Lake</div>
                    </div>
                </div>

                <div class="trigram-label">Upper Trigram</div>
                <div class="trigram-grid" id="upper-trigram-grid">
                    <div class="trigram-card" data-trigram="heaven">
                        <div class="trigram-symbol">‚ò∞</div>
                        <div class="trigram-name">Heaven</div>
                    </div>
                    <div class="trigram-card" data-trigram="earth">
                        <div class="trigram-symbol">‚ò∑</div>
                        <div class="trigram-name">Earth</div>
                    </div>
                    <div class="trigram-card" data-trigram="water">
                        <div class="trigram-symbol">‚òµ</div>
                        <div class="trigram-name">Water</div>
                    </div>
                    <div class="trigram-card" data-trigram="fire">
                        <div class="trigram-symbol">‚ò≤</div>
                        <div class="trigram-name">Fire</div>
                    </div>
                    <div class="trigram-card selected" data-trigram="thunder">
                        <div class="trigram-symbol">‚ò≥</div>
                        <div class="trigram-name">Thunder</div>
                    </div>
                    <div class="trigram-card" data-trigram="wind">
                        <div class="trigram-symbol">‚ò¥</div>
                        <div class="trigram-name">Wind</div>
                    </div>
                    <div class="trigram-card" data-trigram="mountain">
                        <div class="trigram-symbol">‚ò∂</div>
                        <div class="trigram-name">Mountain</div>
                    </div>
                    <div class="trigram-card" data-trigram="lake">
                        <div class="trigram-symbol">‚ò±</div>
                        <div class="trigram-name">Lake</div>
                    </div>
                </div>
            </div>

            <div class="result-hexagram" id="result-hexagram">
                <div class="hex-symbol" id="result-hexagram-symbol"></div>
                <div>
                    <div class="hex-number" id="result-hexagram-number">16</div>
                    <div class="hex-name" id="result-hexagram-name">Enthusiasm</div>
                    <div class="hex-chinese" id="result-hexagram-chinese">Ë±´ (y√π)</div>
                </div>
            </div>
        </div>

        <!-- Reading Section -->
        <div id="reading" class="section" role="tabpanel" aria-labelledby="tab-reading" aria-hidden="true">
            <div class="current-hexagram-display" id="current-hexagram-display">
                <div class="hex-symbol">&#8203;</div>
                <div>
                <div class="hex-number">16</div>
                <div class="hex-name">Enthusiasm</div>
                <div class="hex-chinese">Ë±´ (y√π)</div>
                </div>
            </div>
            
            <div class="translation-toggle">
                <button class="trans-btn active" data-translation="modern">Modern</button>
                <button class="trans-btn" data-translation="wilhelm">Wilhelm</button>
                <button class="trans-btn" data-translation="karcher">Karcher</button>
            </div>

            <div class="reading-text" id="reading-content">
                <h3>Judgment</h3>
                <p>Enthusiasm brings success. It furthers one to install helpers and to set armies marching. When thunder comes forth from the earth, ancient kings made music to honor merit, offering it to the Supreme Deity.</p>

                <h3>Image</h3>
                <p>Thunder comes resounding out of the earth. The image of Enthusiasm. Thus the ancient kings made music to honor merit, and offered it with grandeur to the Supreme Deity, inviting their ancestors to be present.</p>

                <div class="changing-lines">
                    <h3>Changing Lines</h3>
                    
                    <div class="changing-line-item">
                        <div class="line-position">Third Line (Yang)</div>
                        <p>Enthusiasm that looks upward creates remorse. Hesitation brings remorse. Looking to others for enthusiasm leads to regret. Move forward with your own conviction.</p>
                    </div>

                    <div class="changing-line-item">
                        <div class="line-position">Fourth Line (Yin)</div>
                        <p>The source of enthusiasm. He achieves great things. Doubt not. Friends gather around you as hairpins gather the hair. You are the catalyst for collective joy.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the Wilhelm translation data
        import wilhelmData from './assets/iching_wilhelm_translation.js';
        
        // Global variables
        let currentHexagram = 16; // Default to hexagram 16
        let currentTranslation = 'modern';
        
        // Trigram to hexagram mapping
        const trigramToHexagram = {
            'heaven': { symbol: '‚ò∞', binary: '111' },
            'earth': { symbol: '‚ò∑', binary: '000' },
            'water': { symbol: '‚òµ', binary: '010' },
            'fire': { symbol: '‚ò≤', binary: '101' },
            // Use top-to-bottom bit order for trigrams: top, middle, bottom (1=yang, 0=yin)
            'thunder': { symbol: '‚ò≥', binary: '001' },   // bottom yang only
            'wind': { symbol: '‚ò¥', binary: '110' },      // top two yang, bottom yin
            'mountain': { symbol: '‚ò∂', binary: '100' },  // top yang only
            'lake': { symbol: '‚ò±', binary: '011' }       // top yin only
        };
        
        // Binary to hexagram number mapping
        const binaryToHexagram = {
            '111111': 1, '000000': 2, '010001': 3, '100010': 4, '010111': 5, '111010': 6,
            '000010': 7, '010000': 8, '110111': 9, '111011': 10, '000111': 11, '111000': 12,
            '111101': 13, '101111': 14, '000100': 15, '001000': 16, '011001': 17, '100110': 18,
            '000011': 19, '110000': 20, '101001': 21, '100101': 22, '100000': 23, '000001': 24,
            '111001': 25, '100111': 26, '100001': 27, '011110': 28, '010010': 29, '101101': 30,
            '011100': 31, '001110': 32, '001111': 34, '111100': 33, '000101': 36, '101000': 35,
            '110101': 37, '101011': 38, '010100': 39, '001010': 40, '100011': 41, '110001': 42,
            '011111': 43, '111110': 44, '011000': 45, '000110': 46, '011010': 47, '010110': 48,
            '011101': 49, '101110': 50, '001001': 51, '100100': 52, '110100': 53, '001011': 54,
            '001101': 55, '101100': 56, '110110': 57, '011011': 58, '110010': 59, '010011': 60,
            '110011': 61, '001100': 62, '010101': 63, '101010': 64
        };
        
        // Data access functions
function getHexagramByNumber(number) {
  return wilhelmData[number.toString()];
}

function getHexagramByTrigrams(upperTrigram, lowerTrigram) {
  const upperBinary = trigramToHexagram[upperTrigram].binary;
  const lowerBinary = trigramToHexagram[lowerTrigram].binary;
  const fullBinary = upperBinary + lowerBinary;
  console.log(`Binary conversion: ${upperTrigram}(${upperBinary}) + ${lowerTrigram}(${lowerBinary}) = ${fullBinary}`);
  const hexagramNumber = binaryToHexagram[fullBinary];
  console.log(`Hexagram number: ${hexagramNumber}`);
  return hexagramNumber ? getHexagramByNumber(hexagramNumber) : null;
}

function updateHexagramDisplay(hexagramData) {
  if (!hexagramData) return;
  
  const resultDiv = document.getElementById('result-hexagram');
  if (resultDiv) {
                const symbolEl = document.getElementById('result-hexagram-symbol');
                const numberEl = document.getElementById('result-hexagram-number');
                const nameEl = document.getElementById('result-hexagram-name');
                const chineseEl = document.getElementById('result-hexagram-chinese');
                if (symbolEl) symbolEl.textContent = hexagramData.hex_font || '';
                if (numberEl) numberEl.textContent = String(hexagramData.hex);
                if (nameEl) nameEl.textContent = hexagramData.english;
                if (chineseEl) chineseEl.textContent = `${hexagramData.trad_chinese} (${hexagramData.pinyin})`;
  }
}

function updateReadingContent(hexagramData, translationType) {
  const contentDiv = document.getElementById('reading-content');
  const displayDiv = document.getElementById('current-hexagram-display');
  if (!contentDiv || !hexagramData) return;
  
  // Update the hexagram display
  if (displayDiv) {
    displayDiv.innerHTML = `
                    <div class="hex-symbol">${hexagramData.hex_font || ''}</div>
      <div class="hex-number">${hexagramData.hex}</div>
      <div class="hex-name">${hexagramData.english}</div>
      <div class="hex-chinese">${hexagramData.trad_chinese} (${hexagramData.pinyin})</div>
    `;
  }
  
  let content = '';
  
  if (translationType === 'wilhelm') {
    // Wilhelm translation
    content = `
      <h3>Judgment</h3>
      <p>${hexagramData.wilhelm_judgment.text}</p>
      <p><em>${hexagramData.wilhelm_judgment.comments}</em></p>
      
      <h3>Image</h3>
      <p>${hexagramData.wilhelm_image.text}</p>
      <p><em>${hexagramData.wilhelm_image.comments}</em></p>
    `;
  } else if (translationType === 'modern') {
    // Modern translation (placeholder)
    content = `
      <h3>Judgment</h3>
      <p>${hexagramData.english} brings success. It furthers one to install helpers and to set armies marching.</p>
      
      <h3>Image</h3>
      <p>The image of ${hexagramData.english}. Thus the ancient kings made music to honor merit, and offered it with grandeur to the Supreme Deity.</p>
    `;
  } else {
    // Karcher translation (placeholder)
    content = `
      <h3>Judgment</h3>
      <p>${hexagramData.english} - A modern interpretation focusing on personal growth and development.</p>
      
      <h3>Image</h3>
      <p>This hexagram represents the energy of ${hexagramData.english} in your current situation.</p>
    `;
  }
  
  contentDiv.innerHTML = content;
}

        // UI Event Handlers
        function showSection(event, sectionId) {
  // Hide all sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
                section.setAttribute('aria-hidden', 'true');
  });
  
  // Remove active from all tabs
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
  });
  
  // Show selected section
            const activeSection = document.getElementById(sectionId);
            activeSection.classList.add('active');
            activeSection.setAttribute('aria-hidden', 'false');
  
  // Mark active tab
            if (event && event.target) {
  event.target.classList.add('active');
                event.target.setAttribute('aria-selected', 'true');
                event.target.focus();
            }
}

        // Trigram selection
function setupTrigramSelection() {
  document.querySelectorAll('.trigram-card').forEach(card => {
                const activate = () => {
                    const grid = card.closest('.trigram-grid');
      grid.querySelectorAll('.trigram-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
      updateHexagramFromTrigrams();
                };
                card.setAttribute('tabindex', '0');
                card.addEventListener('click', activate);
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        activate();
                    }
    });
  });
}

function updateHexagramFromTrigrams() {
  const lowerTrigram = document.querySelector('#lower-trigram-grid .trigram-card.selected').dataset.trigram;
  const upperTrigram = document.querySelector('#upper-trigram-grid .trigram-card.selected').dataset.trigram;
  
  console.log(`Selected trigrams: Upper=${upperTrigram}, Lower=${lowerTrigram}`);
  
  const hexagramData = getHexagramByTrigrams(upperTrigram, lowerTrigram);
  if (hexagramData) {
                currentHexagram = hexagramData.hex;
    console.log(`Found hexagram: ${hexagramData.hex} - ${hexagramData.english}`);
    updateHexagramDisplay(hexagramData);
                updateReadingContent(hexagramData, currentTranslation);
                try {
                    localStorage.setItem('upperTrigram', upperTrigram);
                    localStorage.setItem('lowerTrigram', lowerTrigram);
                    localStorage.setItem('primaryHexagram', String(hexagramData.hex));
                } catch (_) { /* ignore storage errors */ }
  } else {
    console.log(`No hexagram found for combination: ${upperTrigram} + ${lowerTrigram}`);
  }
}

        // Translation toggle
function setupTranslationToggle() {
  document.querySelectorAll('.trans-btn').forEach(btn => {
                const activate = () => {
      document.querySelectorAll('.trans-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTranslation = btn.dataset.translation;
                    const hexagramData = getHexagramByNumber(currentHexagram);
                    updateReadingContent(hexagramData, currentTranslation);
                    try { localStorage.setItem('translation', currentTranslation); } catch (_) {}
                };
                btn.addEventListener('click', activate);
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        activate();
                    }
    });
  });
}

        function setupCasting() {
            const button = document.getElementById('cast-button');
            const resultEl = document.getElementById('throw-result');
            if (!button || !resultEl) return;

            button.addEventListener('click', async () => {
                if (button.dataset.busy === '1') return;
                button.dataset.busy = '1';
                button.style.opacity = '0.6';
                button.style.pointerEvents = 'none';

                const throwLine = () => {
                    let sum = 0;
                    for (let i = 0; i < 3; i++) sum += Math.random() < 0.5 ? 2 : 3;
                    return sum; // 6,7,8,9
                };

                const lines = [];
                const changingPositions = [];
                const lineDisplays = Array.from(document.querySelectorAll('#cast .hexagram-lines .line-display'));
                for (let i = 0; i < 6; i++) {
                    const sum = throwLine();
                    let kind = '';
                    let changing = false;
                    if (sum === 6) { kind = 'yin'; changing = true; }
                    else if (sum === 7) { kind = 'yang'; }
                    else if (sum === 8) { kind = 'yin'; }
                    else if (sum === 9) { kind = 'yang'; changing = true; }
                    lines.push({ sum, kind, changing });
                    if (changing) changingPositions.push(i + 1);

                    // Animate this line update with a short delay
                    const domIndex = 5 - i;
                    const el = lineDisplays[domIndex];
                    el.classList.add('cast-animate');
                    el.classList.remove('broken', 'changing');
                    if (kind === 'yin') el.classList.add('broken');
                    if (changing) el.classList.add('changing');
                    await new Promise(r => setTimeout(r, 120));
                    el.classList.remove('cast-animate');
                }

                const topToBottom = lines.slice().reverse();
                const toBit = (l) => (l.kind === 'yang' ? '1' : '0');
                const primaryTop = topToBottom.slice(0, 3).map(toBit).join('');
                const primaryBottom = topToBottom.slice(3).map(toBit).join('');
                const primaryBinary = primaryTop + primaryBottom;
                const primaryNumber = binaryToHexagram[primaryBinary];
                const primaryData = primaryNumber ? getHexagramByNumber(primaryNumber) : null;

                const flippedLines = lines.map(l => ({
                    kind: l.changing ? (l.kind === 'yang' ? 'yin' : 'yang') : l.kind
                }));
                const flippedTopToBottom = flippedLines.slice().reverse();
                const resultTop = flippedTopToBottom.slice(0, 3).map(toBit).join('');
                const resultBottom = flippedTopToBottom.slice(3).map(toBit).join('');
                const resultBinary = resultTop + resultBottom;
                const resultNumber = binaryToHexagram[resultBinary];
                const resultData = resultNumber ? getHexagramByNumber(resultNumber) : null;

                const setTrans = (prefix, data) => {
                    if (!data) return;
                    const s = document.getElementById(`${prefix}-hex-symbol`);
                    const n = document.getElementById(`${prefix}-hex-number`);
                    const e = document.getElementById(`${prefix}-hex-english`);
                    const c = document.getElementById(`${prefix}-hex-chinese`);
                    if (s) s.textContent = data.hex_font || '';
                    if (n) n.textContent = String(data.hex);
                    if (e) e.textContent = data.english;
                    if (c) c.textContent = `${data.trad_chinese} (${data.pinyin})`;
                };
                setTrans('primary', primaryData);
                setTrans('result', resultData);

                try {
                    if (primaryData) localStorage.setItem('primaryHexagram', String(primaryData.hex));
                    if (resultData) localStorage.setItem('resultHexagram', String(resultData.hex));
                    localStorage.setItem('changingLines', JSON.stringify(changingPositions));
                } catch (_) {}

                const summary = lines
                    .map((l, idx) => {
                        const pos = idx + 1;
                        const label = l.sum === 6 ? 'Changing Yin (6)' : l.sum === 7 ? 'Young Yang (7)' : l.sum === 8 ? 'Young Yin (8)' : 'Changing Yang (9)';
                        return `Line ${pos}: ${label}`;
                    })
                    .join(' \n');
                resultEl.textContent = summary;

                if (primaryData) {
                    currentHexagram = primaryData.hex;
                    updateHexagramDisplay(primaryData);
                    updateReadingContent(primaryData, currentTranslation);
                }

                // Re-enable button
                button.dataset.busy = '0';
                button.style.opacity = '';
                button.style.pointerEvents = '';
            });
        }
        function restoreTrigramSelection() {
            try {
                const savedUpper = localStorage.getItem('upperTrigram');
                const savedLower = localStorage.getItem('lowerTrigram');
                if (savedUpper) {
                    const upperGrid = document.getElementById('upper-trigram-grid');
                    upperGrid.querySelectorAll('.trigram-card').forEach(c => c.classList.remove('selected'));
                    const upperCard = upperGrid.querySelector(`.trigram-card[data-trigram="${savedUpper}"]`);
                    if (upperCard) upperCard.classList.add('selected');
                }
                if (savedLower) {
                    const lowerGrid = document.getElementById('lower-trigram-grid');
                    lowerGrid.querySelectorAll('.trigram-card').forEach(c => c.classList.remove('selected'));
                    const lowerCard = lowerGrid.querySelector(`.trigram-card[data-trigram="${savedLower}"]`);
                    if (lowerCard) lowerCard.classList.add('selected');
                }
            } catch (_) { /* ignore storage errors */ }
        }
        
        // Initialize the application
        function init() {
            // Render current date in header
            const dateEl = document.querySelector('.date');
            if (dateEl) {
                try {
                    dateEl.textContent = new Intl.DateTimeFormat('en-US', {
                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                    }).format(new Date());
                } catch (_) {
                    dateEl.textContent = new Date().toDateString();
                }
            }

            // Setup UI handlers
    setupTrigramSelection();
    setupTranslationToggle();
            setupCasting();

            // Restore user preferences
            try {
                const savedTranslation = localStorage.getItem('translation');
                if (savedTranslation) {
                    currentTranslation = savedTranslation;
                    document.querySelectorAll('.trans-btn').forEach(b => b.classList.remove('active'));
                    const btn = document.querySelector(`.trans-btn[data-translation="${savedTranslation}"]`);
                    if (btn) btn.classList.add('active');
                }
            } catch (_) { /* ignore storage errors */ }

            restoreTrigramSelection();

            // Initialize hexagram based on current trigram selection
            updateHexagramFromTrigrams();
            // Fallback to default if mapping not found
            if (!currentHexagram) {
                currentHexagram = 16;
                const initialHexagram = getHexagramByNumber(currentHexagram);
    updateHexagramDisplay(initialHexagram);
                updateReadingContent(initialHexagram, currentTranslation);
            }
}

// Make functions globally available
window.showSection = showSection;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>