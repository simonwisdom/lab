<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Content Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>URL Content Analyzer</h1>

        <div class="input-group">
            <label>Mode:</label>
            <div class="mode-selector">
                <label class="radio-label">
                    <input type="radio" name="mode" value="free" checked> 
                    Free Tier (Rate Limited)
                </label>
                <label class="radio-label">
                    <input type="radio" name="mode" value="paid"> 
                    Use Own API Key
                </label>
            </div>
        </div>

        <div id="api-settings" class="input-group" style="display: none;">
            <label for="provider">Provider:</label>
            <select id="provider" class="select-input">
                <option value="anthropic">Anthropic Claude</option>
                <option value="openai">OpenAI</option>
                <option value="gemini">Google Gemini</option>
            </select>
            
            <div class="sub-input">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" placeholder="Enter your API key">
            </div>
            
            <div id="model-selector" class="sub-input">
                <label for="model">Model:</label>
                <select id="model" class="select-input">
                    <!-- Will be populated dynamically -->
                </select>
            </div>

            <div class="pricing-info" id="pricing-info">
                <!-- Will show current model pricing -->
            </div>
        </div>

        <div class="input-group">
            <label for="prompt">Prompt:</label>
            <textarea id="prompt" placeholder="Enter the prompt to send for each URL's content"></textarea>
        </div>

        <div class="input-group">
            <label for="delay">Delay between requests (ms):</label>
            <input type="number" id="delay" value="1000" min="0">
        </div>

        <div class="input-group">
            <label for="urls">URLs (one per line):</label>
            <textarea id="urls" placeholder="Enter URLs, one per line"></textarea>
        </div>

        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>

        <button id="startButton">Start Processing</button>
        <button id="downloadButton" style="display: none;">Download CSV</button>

        <div id="results" class="results"></div>
    </div>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            background: #0066cc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        button:hover {
            background: #0052a3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #downloadButton {
            background: #28a745;
        }

        #downloadButton:hover {
            background: #218838;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .results {
            margin-top: 20px;
        }

        .result-item {
            margin-bottom: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
        }

        .url {
            color: #0066cc;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .status {
            font-size: 14px;
            color: #666;
        }

        .error {
            color: #dc3545;
        }

        .success {
            color: #28a745;
        }

        .mode-selector {
            margin: 10px 0;
        }

        .radio-label {
            display: block;
            margin: 5px 0;
            font-weight: normal;
        }

        .radio-label input {
            margin-right: 8px;
        }

        .pricing-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>

    <script type="module">
        import { LLMClient } from './llm-client.js';
        
        let isProcessing = false;
        let results = [];
        let client = null;

        // UI Elements
        const modeRadios = document.getElementsByName('mode');
        const apiSettings = document.getElementById('api-settings');
        const providerSelect = document.getElementById('provider');
        const modelSelect = document.getElementById('model');
        const startButton = document.getElementById('startButton');
        const downloadButton = document.getElementById('downloadButton');

        // Initialize LLMClient and UI
        async function initializeClient() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            if (mode === 'free') {
                client = new LLMClient();
            } else {
                const provider = providerSelect.value;
                const apiKey = document.getElementById('apiKey').value;
                const model = modelSelect.value;
                
                if (!apiKey) {
                    throw new Error('API key is required for paid mode');
                }
                
                client = new LLMClient({
                    useOwnKey: true,
                    provider,
                    apiKey,
                    model
                });
            }
            
            await client.initialize();
            updateModelList();
        }

        // Update model list based on selected provider
        async function updateModelList() {
            const provider = providerSelect.value;
            const models = client.listModels().filter(m => m.provider === provider);
            
            modelSelect.innerHTML = models.map(m => 
                `<option value="${m.id}">${m.name}</option>`
            ).join('');
            
            updatePricingInfo();
        }

        // Update pricing information
        function updatePricingInfo() {
            const provider = providerSelect.value;
            const model = modelSelect.value;
            const pricing = client.getPricing(provider, model);
            
            document.getElementById('pricing-info').innerHTML = pricing ? 
                `Current pricing: $${pricing.input}/1K tokens (input), $${pricing.output}/1K tokens (output)` :
                'Pricing information not available';
        }

        // Event Listeners
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                apiSettings.style.display = this.value === 'paid' ? 'block' : 'none';
                initializeClient().catch(console.error);
            });
        });

        providerSelect.addEventListener('change', updateModelList);
        modelSelect.addEventListener('change', updatePricingInfo);

        startButton.addEventListener('click', startProcessing);
        downloadButton.addEventListener('click', downloadResults);

        // Helper Functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            document.querySelector('.progress-fill').style.width = `${percentage}%`;
        }

        async function processUrl(url) {
            const response = await fetch('https://r.jina.ai/' + url);
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.statusText}`);
            }
            return response.text();
        }

        function preprocessContent(content) {
            let processed = content;
            processed = processed.replace(/<[^>]+>/g, '');
            processed = processed.replace(/\n{3,}/g, '\n\n');
            
            const boilerplate = [
                /This website uses cookies/i,
                /Accept cookies/i,
                /Privacy Policy/i,
                /Terms of Service/i,
                /Â©\s*\d{4}/,
                /All rights reserved/i
            ];
            
            boilerplate.forEach(pattern => {
                processed = processed.replace(pattern, '');
            });
            
            return processed.trim();
        }

        async function processWithLLM(content, prompt) {
            const cleanedContent = preprocessContent(content);
            return await client.sendMessage(`Content from webpage:\n\n${cleanedContent}\n\nPrompt:\n${prompt}`);
        }

        async function startProcessing() {
            const prompt = document.getElementById('prompt').value.trim();
            const delay = parseInt(document.getElementById('delay').value, 10);
            const urlList = document.getElementById('urls').value.trim().split('\n').filter(url => url);

            if (!prompt || urlList.length === 0) {
                alert('Please fill in all required fields');
                return;
            }

            if (isProcessing) return;
            
            try {
                await initializeClient();
            } catch (error) {
                alert(error.message);
                return;
            }

            isProcessing = true;
            results = [];
            startButton.disabled = true;
            downloadButton.style.display = 'none';
            document.getElementById('results').innerHTML = '';

            let processed = 0;
            updateProgress(0, urlList.length);

            for (const url of urlList) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                resultDiv.innerHTML = `
                    <div class="url">${url}</div>
                    <div class="status">Processing...</div>
                `;
                document.getElementById('results').insertBefore(resultDiv, document.getElementById('results').firstChild);

                try {
                    const content = await processUrl(url);
                    resultDiv.querySelector('.status').textContent = 'Got content, analyzing...';
                    
                    const analysis = await processWithLLM(content, prompt);
                    
                    results.push({
                        url,
                        content,
                        analysis
                    });

                    resultDiv.querySelector('.status').className = 'status success';
                    resultDiv.querySelector('.status').textContent = 'Completed';
                } catch (error) {
                    console.error(`Error processing ${url}:`, error);
                    results.push({
                        url,
                        content: '',
                        analysis: `Error: ${error.message}`
                    });
                    resultDiv.querySelector('.status').className = 'status error';
                    resultDiv.querySelector('.status').textContent = `Error: ${error.message}`;
                }

                processed++;
                updateProgress(processed, urlList.length);

                if (processed < urlList.length) {
                    await sleep(delay);
                }
            }

            downloadButton.style.display = 'inline-block';
            startButton.disabled = false;
            isProcessing = false;
        }

        function downloadResults() {
            const csv = Papa.unparse(results.map(r => ({
                URL: r.url,
                Content: r.content,
                Analysis: r.analysis
            })));

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'url_analysis.csv';
            link.click();
        }

        // Initialize on load
        initializeClient().catch(console.error);
    </script>
</body>
</html>